<?xml version="1.0" encoding="UTF-8"?>

<page>
  <name>ZpDIC の akrantiain 実装について</name>

  <h1>日記 (2017 年 3 月 31 日)</h1>
  <p>
    ZpDIC では ver 1.7.0 から akrantiain が実行できますが、実装はオリジナルのものとは異なります。
    ということで、特に変換規則の適用について、どういう実装になっているかを簡単に解説しておこうと思います。
    オリジナルの実装の解説は、<a href="https://sozysozbot.github.io/akrantiain2/manuals/conversions_ja.htm" target="_blank">こちら</a>を参照してください。
    以下は、ver 1.7.1 より少し後 (コミット c058cc8) の実装の解説です。
    ver 1.7.1 は左右条件のチェックを手抜きしているので、以下の説明とは少し違います。
  </p>
  <p>
    まず、入力を 1 文字ずつ分割して Stat (1 文字と <m>null</m> の対のリスト, <m>AkrantiainElementGroup</m> クラスで管理) に変換します。
    Stat を構成する各 Stat 素 (1 文字と <m>null</m> の対, <m>AkrantiainElement</m> クラスで管理) には、順にインデックスを振っておきます。
    以下、「インデックス」と言ったら、Stat 素のインデックスを指し、入力文字列のインデックスではないことに注意してください (Stat 素の fst が 2 文字以上になることがあるので両者は一般に一致しない)。
    この Stat に対して変換規則を順に適用していく点は、オリジナルの実装と同じです。
  </p>
  <p>
    変換規則は、マッチ可能オブジェクト (<m>AkrantiainMatchable</m> インターフェースで管理) のリストと Phoneme のリストの集まりとして考えます。
    <c>!vowel "a" ("k"|"g") -&gt; /A/ $</c> という規則なら、<c>!vowel</c>, <c>"a"</c>, <c>("k"|"g")</c> がマッチ可能オブジェクトです。
    マッチ可能オブジェクトは、Stat とマッチ開始位置インデックスを受け取り、その位置から右方向にマッチするかどうかを調べ、マッチしたならばマッチ範囲の右端のインデックスを返し、マッチしないなら <m>null</m> を返すメソッド (<m>matchRight</m> メソッド) をもちます。
    また、受け取った開始位置インデックスから左方向にマッチするかどうかを調べるメソッド (<m>matchLeft</m> メソッド) ももちます。
  </p>
  <p>
    変換規則の適用には、以下の処理をするメソッド (<m>applyOnce</m> メソッド) を用います。
    このメソッドは、Stat と調査開始位置インデックスを受け取り、そのインデックスから規則がマッチするか調べ、マッチしたならさらに変換も施し、マッチ範囲の右端のインデックスとマッチ範囲のみを変換してできた Stat 素のリストを返します。
    マッチしないなら <m>null</m> を返します。
    <m>applyOnce</m> メソッドの処理は以下のように行われます。
  </p>
  <p>
    まず、調査中インデックス (<i>I</i> とおく) を受け取った調査開始インデックスに設定し、変換結果の Stat 素を格納しておくために空のリスト (<i>L</i> とおく) を用意します。
    規則が左条件をもつならば、<m>matchLeft</m> メソッドを用いて、<i>I</i> の位置から左方向に左条件がマッチするかを調べ、マッチすれば次に進みます。
    規則の Select (左条件でも右条件でもないもの) たちの最初の Select を取り出し、<m>matchRight</m> メソッドを用いて、<i>I</i> の位置から右方向にマッチするかを調べ、マッチしたら返り値であるマッチ範囲の右端インデックスを <i>I</i> に新たに設定します。
    さらに、マッチ箇所を 1 つの Stat 素にまとめたものを用意して、その snd に変換先の Phoneme の値を設定し、<i>L</i> に追加します。
    この処理を Select たちに対して順番に行います。
    全ての Select がマッチしたならば、最後に右条件のチェックを行います。
    規則が右条件をもつならば、<m>matchRight</m> メソッドを用いて、<i>I</i> の位置から右方向に右条件がマッチするかを調べ、マッチしたら次に進みます。
    ここまでマッチに失敗することなく辿り着いたならば、マッチ範囲の右端インデックスとして <i>I</i> を返し、変換してできた Stat 素のリストとして <i>L</i> を返します。
    途中でマッチに失敗したならば <m>null</m> を返します。
  </p>
  <p>
    変換規則の適用は、この <m>applyOnce</m> メソッドを用いて以下のように行われます。
  </p>
  <p>
    まず、調査開始インデックス (<i>J</i> とおく) を 0 に設定し、変換結果の Stat を格納しておくための空の Stat (<i>S</i> とおく) を用意します。
    Stat と <i>J</i> を <m>applyOnce</m> メソッドに渡します。
    その結果が <m>null</m> ならば、その位置でのマッチ失敗なので、Stat の <i>J</i> 番目の Stat 素をそのまま <i>S</i> に追加し、<i>J</i> の値を 1 増やします。
    結果が <m>null</m> でなければ、返り値の変換後 Stat 素リストの要素を全て <i>S</i> に追加し、マッチ範囲の右端インデックスを <i>J</i> に新たに設定します。
    この処理を、<i>J</i> がもとの Stat のサイズに達するまで繰り返します。
    繰り返しが終わったら、<i>S</i> がその規則の適用結果となります。
  </p>
  <p>
    以上の処理を、全ての変換規則に対して順番に行います。
    最後に得られた Stat の snd を全て繋げれば、出力の完成です。
  </p>

</page>
